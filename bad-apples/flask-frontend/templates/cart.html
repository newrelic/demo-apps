{% extends "base.html" %}

{% block title %}Shopping Cart - Bad Apples Orchard{% endblock %}

{% block content %}
<section class="cart">
    <h1>Shopping Cart</h1>

    {% if cart_items %}
    <div class="cart-container">
        <table class="cart-table">
            <thead>
                <tr>
                    <th>Apple Variety</th>
                    <th>Price per lb</th>
                    <th>Quantity (lbs)</th>
                    <th>Subtotal</th>
                    <th>Action</th>
                </tr>
            </thead>
            <tbody>
                {% for item in cart_items %}
                <tr>
                    <td>
                        <div style="display: flex; align-items: center; gap: 1rem;">
                            <img src="{{ url_for('static', filename='images/' + (item.name|variety_image)) }}"
                                 alt="{{ item.name }}"
                                 style="width: 60px; height: 60px; object-fit: cover; border-radius: 5px;">
                            <strong>{{ item.name }}</strong>
                        </div>
                    </td>
                    <td>${{ "%.2f"|format(item.price_per_lb|float) }}</td>
                    <td>{{ "%.1f"|format(item.quantity_lbs|float) }} lbs</td>
                    <td>${{ "%.2f"|format((item.price_per_lb|float) * (item.quantity_lbs|float)) }}</td>
                    <td>
                        <button class="btn btn-secondary remove-from-cart"
                                data-variety-id="{{ item.variety_id }}">
                            Remove
                        </button>
                    </td>
                </tr>
                {% endfor %}
            </tbody>
            <tfoot>
                <tr>
                    <td colspan="3"><strong>Total:</strong></td>
                    <td colspan="2">
                        <strong>
                            {% set total = namespace(value=0) %}
                            {% for item in cart_items %}
                                {% set total.value = total.value + ((item.price_per_lb|float) * (item.quantity_lbs|float)) %}
                            {% endfor %}
                            ${{ "%.2f"|format(total.value) }}
                        </strong>
                    </td>
                </tr>
            </tfoot>
        </table>

        <div class="cart-actions">
            <a href="/catalog" class="btn btn-secondary">Continue Shopping</a>
            <a href="/checkout" class="btn btn-primary" id="checkout-btn">Proceed to Checkout</a>
            <button class="btn btn-secondary" id="clear-cart-btn">Clear Cart</button>
        </div>
    </div>
    {% else %}
    <div class="empty-cart">
        <p>Your cart is empty.</p>
        <a href="/catalog" class="btn btn-primary">Browse Our Apples</a>
    </div>
    {% endif %}
</section>

<div id="notification" class="notification hidden"></div>
{% endblock %}

{% block extra_scripts %}
<script>
// Remove from cart
document.querySelectorAll('.remove-from-cart').forEach(button => {
    button.addEventListener('click', async function() {
        const varietyId = this.getAttribute('data-variety-id');

        try {
            const response = await fetch('/api/cart/remove', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    variety_id: parseInt(varietyId)
                })
            });

            const result = await response.json();

            if (response.ok) {
                showNotification('Item removed from cart', 'success');
                setTimeout(() => {
                    location.reload();
                }, 1000);
            } else {
                showNotification(result.error || 'Failed to remove item', 'error');
            }
        } catch (error) {
            showNotification('Error removing item', 'error');
        }
    });
});

// Clear cart
document.getElementById('clear-cart-btn')?.addEventListener('click', async function() {
    if (!confirm('Are you sure you want to clear your cart?')) {
        return;
    }

    try {
        const response = await fetch('/api/cart/clear', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            }
        });

        const result = await response.json();

        if (response.ok) {
            showNotification('Cart cleared', 'success');
            setTimeout(() => {
                location.reload();
            }, 1000);
        } else {
            showNotification('Failed to clear cart', 'error');
        }
    } catch (error) {
        showNotification('Error clearing cart', 'error');
    }
});

function showNotification(message, type) {
    const notification = document.getElementById('notification');
    notification.textContent = message;
    notification.className = 'notification ' + type;
    notification.classList.remove('hidden');

    setTimeout(() => {
        notification.classList.add('hidden');
    }, 3000);
}
</script>
{% endblock %}
