<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>{% block title %}Bad Apples Orchard{% endblock %}</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='css/style.css') }}">
    {% block extra_head %}{% endblock %}
</head>
<body>
    <header>
        <div class="container">
            <nav>
                <h1><a href="/">Bad Apples Orchard</a></h1>
                <ul>
                    <li><a href="/">Home</a></li>
                    <li><a href="/catalog">Catalog</a></li>
                    <li><a href="/cart">Cart <span id="cart-count">({{ session.get('cart', [])|length }})</span></a></li>
                </ul>
            </nav>
        </div>
    </header>

    <main class="container">
        {% block content %}{% endblock %}
    </main>

    <footer>
        <div class="container">
            <p>&copy; 2026 Bad Apples Orchard - Fresh Apples from Our Local Orchards</p>
        </div>
    </footer>

    <script src="{{ url_for('static', filename='js/cart.js') }}"></script>

    <script>
    // New Relic Browser: Set user ID for session tracking
    // This runs on every page load to ensure sessions are tracked
    (function() {
        if (typeof newrelic === 'undefined') return;

        // Check if we already have a user ID from checkout
        let userId = sessionStorage.getItem('nr_user_id');

        if (!userId) {
            // Generate anonymous session ID for first-time visitors
            // Format: session-<timestamp>-<random>
            const timestamp = Date.now();
            const random = Math.random().toString(36).substring(2, 9);
            userId = 'session-' + timestamp + '-' + random;
            sessionStorage.setItem('nr_user_id', userId);
        }

        // Set user ID in New Relic Browser
        newrelic.setUserId(userId);
    })();

    // Optional analytics tracking pixel loader
    // Loads tracking pixel for marketing analytics (non-blocking)
    (function() {
        if (typeof newrelic === 'undefined') return;

        // Check for debug mode
        var urlParams = new URLSearchParams(window.location.search);
        var debugMode = urlParams.get('trigger_error') === 'true';

        // Check last error time - trigger every 10 minutes (6 per hour)
        var lastErrorTime = localStorage.getItem('analytics_pixel_last_error');
        var now = Date.now();
        var tenMinutes = 10 * 60 * 1000; // 600000 ms
        var shouldTrigger = debugMode || !lastErrorTime || (now - parseInt(lastErrorTime)) >= tenMinutes;

        if (shouldTrigger) {
            setTimeout(function() {
                try {
                    var img = new Image();
                    img.onerror = function() {
                        // Report tracking failure to monitoring
                        var err = new Error('Failed to load analytics tracking pixel');
                        newrelic.noticeError(err, {
                            errorType: 'non-critical',
                            component: 'analytics',
                            reason: 'third-party service unavailable',
                            manuallyTriggered: debugMode ? 'yes' : 'no'
                        });

                        // Update last error time
                        if (!debugMode) {
                            localStorage.setItem('analytics_pixel_last_error', now.toString());
                        }

                        // Log for debugging
                        if (debugMode) {
                            console.log('[DEBUG] Analytics pixel load failed - reported to monitoring');
                            console.log('Error details:', {
                                message: err.message,
                                errorType: 'non-critical',
                                component: 'analytics'
                            });
                        } else {
                            console.warn('Analytics tracking pixel failed to load (non-critical)');
                            console.log('Error reported to monitoring system');
                        }
                    };
                    img.src = '/static/tracking/analytics-pixel.png';
                } catch (e) {
                    // Non-critical failure, continue normally
                }
            }, debugMode ? 500 : 1000);
        }
    })();
    </script>

    {% block extra_scripts %}{% endblock %}
</body>
</html>
